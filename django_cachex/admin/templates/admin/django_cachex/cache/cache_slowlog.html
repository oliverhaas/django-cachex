{% extends "admin/base_site.html" %}
{% load i18n admin_urls static %}

{% block extrastyle %}
{{ block.super }}
<link rel="stylesheet" href="{% static "admin/css/forms.css" %}">
<link rel="stylesheet" href="{% static "admin/css/changelists.css" %}">
<style type="text/css">
    {% include "admin/django_cachex/cache/styles.css" %}
</style>
{% endblock %}

{% block bodyclass %}{{ block.super }} app-django_cachex model-cache change-list{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
    <a href="{% url 'admin:index' %}">{% trans 'Home' %}</a>
    &rsaquo; <a href="{% url 'admin:django_cachex_cache_changelist' %}">{% trans 'Cache Instances' %}</a>
    &rsaquo; <a href="{% url 'admin:django_cachex_key_changelist' %}?cache={{ cache_name }}">{{ cache_name }}</a>
    &rsaquo; {% trans 'Slow Log' %}
</div>
{% endblock %}

{% block content %}
<div id="content-main">
    <!-- Object tools -->
    <ul class="object-tools">
        <li>
            <a href="{% url 'admin:django_cachex_key_changelist' %}?cache={{ cache_name }}">{% trans 'Back to Keys' %}</a>
        </li>
        <li>
            <a href="{% url 'admin:django_cachex_cache_change' cache_name %}">{% trans 'Info' %}</a>
        </li>
        <li>
            <a href="?{% if not help_active %}help=1{% endif %}">{% trans 'Help' %}</a>
        </li>
    </ul>

    {% if not slowlog_supported %}
    <p class="errornote">
        {% trans 'Slow log is not supported for this cache backend.' %}
    </p>
    {% endif %}

    {% if slowlog_data %}

    {% if slowlog_data.error %}
    <p class="errornote">
        {{ slowlog_data.error }}
    </p>
    {% else %}

    <!-- Count selector -->
    <form method="get" class="count-form">
        <label for="count">{% trans 'Show' %}</label>
        <select name="count" id="count" onchange="this.form.submit()">
            <option value="10" {% if count == 10 %}selected{% endif %}>10</option>
            <option value="25" {% if count == 25 %}selected{% endif %}>25</option>
            <option value="50" {% if count == 50 %}selected{% endif %}>50</option>
            <option value="100" {% if count == 100 %}selected{% endif %}>100</option>
        </select>
        <span class="quiet">{% trans 'entries' %} ({{ slowlog_data.length }} {% trans 'total in log' %})</span>
    </form>

    <!-- Slow Log Entries -->
    <fieldset class="module aligned">
        <h2>{% trans 'Slow Queries' %}</h2>
        {% if slowlog_data.entries %}
        <div class="results">
            <table id="result_list" style="width: 100%;">
                <thead>
                    <tr>
                        <th scope="col" style="width: 60px;"><div class="text"><span>{% trans 'ID' %}</span></div></th>
                        <th scope="col" style="width: 160px;"><div class="text"><span>{% trans 'Time' %}</span></div></th>
                        <th scope="col" style="width: 100px;"><div class="text"><span>{% trans 'Duration' %}</span></div></th>
                        <th scope="col"><div class="text"><span>{% trans 'Command' %}</span></div></th>
                        <th scope="col" style="width: 120px;"><div class="text"><span>{% trans 'Client' %}</span></div></th>
                    </tr>
                </thead>
                <tbody>
                    {% for entry in slowlog_data.entries %}
                    <tr class="{% cycle 'row1' 'row2' %}">
                        <td class="quiet">{{ entry.id }}</td>
                        <td class="quiet">
                            {% if entry.timestamp %}
                            <code>{{ entry.timestamp|date:"Y-m-d H:i:s" }}</code>
                            {% else %}
                            -
                            {% endif %}
                        </td>
                        <td class="{% if entry.duration_us >= 100000 %}duration-slow{% elif entry.duration_us >= 10000 %}duration-medium{% else %}duration-fast{% endif %}">
                            {% if entry.duration_us >= 1000000 %}
                            <code>{{ entry.duration_us|floatformat:0 }} &micro;s ({{ entry.duration_us|divisibleby:1000000 }}s)</code>
                            {% elif entry.duration_us >= 1000 %}
                            <code>{{ entry.duration_us }} &micro;s ({{ entry.duration_us|floatformat:0 }}ms)</code>
                            {% else %}
                            <code>{{ entry.duration_us }} &micro;s</code>
                            {% endif %}
                        </td>
                        <td class="command-cell">
                            <code>{% for arg in entry.command %}{{ arg }} {% endfor %}</code>
                        </td>
                        <td class="quiet">
                            {% if entry.client %}{{ entry.client }}{% endif %}
                            {% if entry.client_name %}<br><small>{{ entry.client_name }}</small>{% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="quiet" style="padding: 10px;">{% trans 'No slow queries recorded.' %}</p>
        {% endif %}
    </fieldset>
    {% endif %}
    {% endif %}

    <div class="submit-row">
        <a href="{% url 'admin:django_cachex_key_changelist' %}?cache={{ cache_name }}" class="closelink">{% trans 'Back to Keys' %}</a>
    </div>
</div>
{% endblock %}
